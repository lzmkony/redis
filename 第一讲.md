# redis 讲义

1. 第一课  redis 源码的编译、安装、调试  源代码整体认识 （李兆蒙  ）
2. 第二课 redis 5大数据类型以及实现原理 （余菲）
3. 第三课  hyperloglog.c  geo.c 数据结构解读   （何小松 肖清华 ）
4. 第四课 redis 6种过期策略以及实现、包括（rehash 等） （王宇 邢延辉）
5. 第五课  redis 持久化实现原理 aof rdb    （丁家佳）
6. 第六课 redis 异步网络框架  事件处理器  （卢玮）

未涉及到的部分

1. redis Modules
2. redis 集群管理

## redis 第一课 redis 入门


### 第一节 redis 编译、安装、 调试

 redis 源代码地址代码地址  https://github.com/antirez/redis
 本次讲义 采用redis 5.0 模块
  源代码目录结构 src 模块

|文件名     |职责|
|:-         |:-|
|adlist|双向链表结构
|ae_epoll | epoll 事件|
|ae_evport |event ports 事件 Solaris|
|ae_kqueue |实现消息队列的处理|
|ae        |用于事件的处理|
|ae_select |处理select事件|
|anet | 网络处理|
|aof| 实现aof 模式|
|asciilogo| 这是个log|
|atomicvar | 计数器|
|bio      | 后台线程模型处理任务|
|bitops| 二进制位操作命令的实现文件。|
|blocked | 实现 BLPOP 命令和 WAIT 命令的阻塞效果。|
|childinfo | 处理子进程|
|cluster| 集群建立与通信|
|config| 配置文件解析|
|crc16 crc64 | crc 校验算法|
|db| redis db 的实现|
|debug debugmacros|调试实现|
|defrag| 内存碎片整理|
|dict| 字典实现|
|endianconv | 大端、小端(高低位)转换函数|
|evict | 内存淘汰机制|
|expire| 过期处理|
|fmacros| 一些移植性方面的宏|
|geo geohash geohash_helper| geo 地理位置实现|
|help | utils/generate-command-help.rb 程序自动生成的命令帮助信息|
|hyperloglog | hyperloglog 数据结构实现|
|intset| 整数集合数据结构的实现，用于优化 SET 类型
| lantency | 查看延迟
|lazyfree| 惰性删除或延迟释放 再也不担心大key释放问题了|
|listpack | 列表序列 字符串类型|
|lzf_c 、 lzf_d、 lzf 、 lzfP| lzf压缩 算法|
|memtest | 内存测试|
|module| module 模块|
|multi| redis 事务|
|networking| Redis 的客户端网络操作库|
|notify |Redis 的数据库通知实现|
|object | 对象系统实现|
|pqsort| 快速排序 quick sort|
|pubsub| redis 发布订阅模式|
|quicklist | 快速列表ziplist组成的双向链表|
|rand | 伪随机数|
|rax | 基础树结构实现|
|rdb | rdb 持久化实现|
|redis-benchmark| benchmark 性能测试|
|redis-check-aof redis-check-rdb|RDB 文件和 AOF 文件的合法性检查程序|
|redis-cli | redis客户端实现|
|redisassert| redis 断言|
|redismodule| module 定义|
|redis-trib.rb| 集群管理程序|
|relase | 编译版本信息|
|replication| 复制功能实现|
|rio | redis io 封装|
|scripting | 脚本程序|
|sds sdsalloc| sds 数据结构 sds redis默认字符串表示|
|sentinel| Redis Sentinel 高可用实现|
|server | redis 核心逻辑维护|
|setproctitle| 环境变量|
|sha1 | sha1 计算校验函数|
|siphash | 减少hash flooding 攻击|
|slowlog | 慢日志|
|solarisfixes | 处理Solaris 系统bug|
|sort| 实现sort命令|
|sparkline| 用字符串画图|
|stream | 多消费者消费队列|
|syncio| 同胞不i/o操作|
|t_hash|hash 数据结构|
|t_list|list 数据结构|
|t_set|set 数据结构|
|t_strem| strem 数据结构|
|t_string| 字符串数据结构|
|t_zset|set 数据结构|
|testhelp|测试辅助宏|
|util |工具类函数|
|version|记录了 Redis 的版本号|
|ziplist|ZIPLIST 数据结构的实现，用于优化 LIST 类型。|
|zipmap| ZIPMAP 数据结构的实现|
|zmalloc| 内存管理|

### redis 协议

   1. (+) 表示一个正确的状态信息，具体信息是当前行+后面的字符。
   2. (-)  表示一个错误信息，具体信息是当前行－后面的字符。
   3. (*) 批量回复是一个数组形式,*后表示数组上长度。
   4. ($) 表示下一行数据长度，不包括换行符长度\r\n,$后面则是对应的长度的数据。
   5. (:) 表示返回一个数值，：后面是相应的数字节符。

   举例: get 12345  转化成协议  *2\r\n$3\r\nGET\r\n$5\r\n HENRY\r\n

### redis 基础结构定义 server.h

```c
    // redis 结构对象
    redisObject
    redisDb
    // 客户端连接结构
    client
    // 共享对象
    sharedObjectsStruct
    // redis server 结构
    redisServer
    // redis 命令结构
    redisCommand

   ```

### redis  server 的启动

  核心函数

  ```c

  // 对数据库执行删除过期键，调整大小，以及主动和渐进式 rehash
  void databasesCron(void)

  // redis 时间中断器 类似于定时任务 每秒调用 server.hz 次
  int serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData)

  // 检查客户端信息
  clientsCron();
  // 数据库定时执行事件
  databasesCron();
  // 初始化服务器配置
  void initServerConfig(void)
  // 监听端口
  int listenToPort(int port, int *fds, int *count)
  // 初始化服务
  initServer(void)
  // 读取执行命令
  //void call(client *c, int flags)
  int processCommand(client *c)

  // 获取info命令信息
  sds genRedisInfoString(char *section)

  // 解析并加载配置文件重的信息
  loadServerConfig(configfile,options);

  ```

### 断点跟踪一个命令是如何执行的 以vscode 为例子

  ``` c
  // 创建客户端链接
  1 client *createClient(int fd)

  // 读取客户端的查询缓冲区内容
  2 void readQueryFromClient(aeEventLoop *el, int fd, void *privdata, int mask)

  // 处理客户端输入的命令内容
  3 void processInputBuffer(client *c)

  // 执行命令
  4 int processCommand(client *c) 

  // 尝试将回复添加到 c->buf 中
  5 void addReply(client *c, robj *obj)
  ```

### bio background IO 操作

1. 创建不同类型线程 处理aof lazyfree close file
2. 将任务加入到线程队列中
3. 执行任务
4. 循环执行

```c
// 初始化bio 线程
void bioInit(void);
// 创建一个后台任务
void bioCreateBackgroundJob(int type, void *arg1, void *arg2, void *arg3);
// 后台处理任务
void *bioProcessBackgroundJobs(void *arg)

// 返回等待中的 type 类型的工作的数量
unsigned long long bioPendingJobsOfType(int type);
// 阻塞等待某个类型的BIO任务的执行，返回等待任务个数
unsigned long long bioWaitStepOfType(int type);
// 崩溃时候强制杀死线程
void bioKillThreads(void);
```

### 简述redis dict 的rehash scan lazyfree 等

  简单描述该模块作用意义，具体原理后续课程分享